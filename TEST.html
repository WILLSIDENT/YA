<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>TEST | WILLSIDENT</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f8fa;
      margin: 0;
      padding: 2rem;
      max-width: 600px;
      margin: auto;
    }
    form {
      background: #fff;
      border: 1px solid #ccc;
      padding: 1rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    input, textarea {
      width: 100%;
      padding: 0.6rem;
      margin-bottom: 0.8rem;
      border: 1px solid #ccc;
      font-size: 1rem;
    }
    button {
      background: #000000;
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      font-weight: bold;
      cursor: pointer;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      background: white;
      border: 1px solid #ccc;
      margin-bottom: 1rem;
      padding: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      position: relative;
    }
    .name {
      font-weight: bold;
      margin-bottom: 0.3rem;
    }
    .message {
      margin-bottom: 0.5rem;
    }
    .meta {
      font-size: 0.8rem;
      color: #555;
    }
    .delete-btn {
      position: absolute;
      top: 0.8rem;
      right: 0.8rem;
      font-size: 0.8rem;
      color: red;
      cursor: pointer;
      background: none;
      border: none;
    }
  </style>
</head>
<body>

<form id="f">
  <input id="n" placeholder="名前">
  <textarea id="m" placeholder="いまどうしてる？"></textarea>
  <button>投稿</button>
</form>

<ul id="l"></ul>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDu7kx3msV9CvOzxD9ilKmWfzkT3YHFcMg",
  authDomain: "willsident-pj.firebaseapp.com",
  projectId: "willsident-pj",
  storageBucket: "willsident-pj.firebasestorage.app",
  messagingSenderId: "791017364363",
  appId: "1:791017364363:web:b2f1408377544c4de6ed8e",
  measurementId: "G-BEDL3WPVJ2"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
let uid = null;

signInAnonymously(auth);
onAuthStateChanged(auth, user => {
  if (!user) return;
  uid = user.uid;

  const f = document.getElementById('f');
  const n = document.getElementById('n');
  const m = document.getElementById('m');
  const l = document.getElementById('l');

  f.onsubmit = async e => {
    e.preventDefault();
    if (!n.value || !m.value) return;
    await addDoc(collection(db, "comments"), {
      name: n.value,
      message: m.value,
      timestamp: new Date(),
      uid: uid
    });
    n.value = "";
    m.value = "";
  };

  const q = query(collection(db, "comments"), orderBy("timestamp", "desc"));
  onSnapshot(q, snap => {
    l.innerHTML = "";
    snap.forEach(d => {
      const c = d.data(), id = d.id;
      const li = document.createElement("li");
      const date = c.timestamp.toDate().toLocaleString("ja-JP");
      li.innerHTML = `
        <div class="name">${c.name}</div>
        <div class="message">${c.message}</div>
        <div class="meta">${date}</div>
        ${uid === c.uid ? `<button class="delete-btn" data-id="${id}">削除</button>` : ""}
      `;
      l.appendChild(li);
    });
    l.querySelectorAll(".delete-btn").forEach(b => {
      b.onclick = () => deleteDoc(doc(db, "comments", b.dataset.id));
    });
  });
});
</script>

</body>
</html>
