<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DRAW_TEST</title>
  <style>
    :root { --accent: rgb(2,254,164); }
    html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; background:#f0f0f0; font-family:sans-serif; }
    /* ツールバー */
    #toolbar {
      position: fixed; top: 10px; right: 10px;
      width: 240px; padding: 12px;
      background: #fff; border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      display: flex; flex-direction: column;
      align-items: center; gap: 12px;
      z-index: 1000; user-select: none; touch-action: none;
    }
    /* ペン/消しゴム 横並び */
    #toolSelector { display:flex; gap:6px; width:100%; }
    #toolSelector button { flex:1; padding:6px 0; border:none; border-radius:4px; background:#e0e0e0; cursor:pointer; font-size:.85rem; }
    #toolSelector button.active { background:#000; color:#fff; }
    /* アクションボタン */
    #toolbar > button:not(#penBtn):not(#eraserBtn) { width:100%; padding:6px 0; border:none; border-radius:4px; background:#e0e0e0; cursor:pointer; font-size:.85rem; }
    /* スライダー */
    #toolbar span, #toolbar input[type=range] { width:100%; }
    #toolbar input[type=range] { appearance:none; height:4px; background:#000; border-radius:2px; cursor:pointer; margin:0; }
    #toolbar input[type=range]::-webkit-slider-thumb { appearance:none; width:12px; height:12px; border-radius:50%; background:#fff; border:2px solid #000; margin-top:-4px; }
    #toolbar input[type=range]::-moz-range-thumb { width:12px; height:12px; border-radius:50%; background:#fff; border:2px solid #000; }
    /* カラーピッカー */
    #colorPickerContainer { position:relative; width:200px; height:200px; }
    #hueRing { width:200px; height:200px; border-radius:50%; cursor:crosshair; }
    #svBox { position:absolute; top:50px; left:50px; width:100px; height:100px; cursor:crosshair; }
    /* プレビュー */
    #previewContainer { display:flex; align-items:center; gap:6px; width:100%; }
    .preview { width:28px; height:28px; border:1px solid #000; border-radius:4px; cursor:pointer; }
    #currentColor { border:3px solid #000!important; }
    #rgbValue { font-size:.8rem; user-select:text; }
    /* レイヤー */
    #layerControls { display:flex; flex-direction:column; gap:6px; width:100%; }
    .layerControl { display:flex; align-items:center; gap:6px; width:100%; }
    .layerControl button { flex:5; padding:4px 0; border:none; border-radius:4px; background:#e0e0e0; cursor:pointer; font-size:.85rem; }
    .layerControl button.active { background:#000; color:#fff; }
    .layerControl input[type=range] { flex:5; appearance:none; height:4px; background:#000; border-radius:2px; cursor:pointer; }
    .layerControl input[type=range]::-webkit-slider-thumb { appearance:none; width:12px; height:12px; border-radius:50%; background:#fff; border:2px solid #000; margin-top:-4px; }
    .layerControl input[type=range]::-moz-range-thumb { width:12px; height:12px; border-radius:50%; background:#fff; border:2px solid #000; }
    /* Canvas */
    canvas#viewCanvas { position:absolute; top:0; left:0; width:100%; height:100%; cursor:crosshair; touch-action:none; }
  </style>
</head>
<body>
  <div id="toolbar">
    <div id="toolSelector">
      <button id="penBtn" class="active">Pen</button>
      <button id="eraserBtn">Eraser</button>
    </div>
    <span>
      <label>Pen Size: <span id="penSizeLabel">5</span></label>
      <input id="penSize" type="range" min="1" max="50" value="5">
    </span>
    <span>
      <label>Eraser Size: <span id="eraserSizeLabel">20</span></label>
      <input id="eraserSize" type="range" min="1" max="50" value="20">
    </span>
    <div id="colorPickerContainer">
      <canvas id="hueRing" width="200" height="200"></canvas>
      <canvas id="svBox" width="100" height="100"></canvas>
    </div>
    <div id="previewContainer">
      <div id="currentColor" class="preview"></div>
      <div id="memoryColor" class="preview"></div>
      <div id="rgbValue">rgb(0, 0, 0)</div>
    </div>
    <div id="layerControls">
      <div class="layerControl">
        <button class="layerBtn active" data-idx="2">Layer3</button>
        <input class="layerOpacity" data-idx="2" type="range" min="0" max="100" value="100">
      </div>
      <div class="layerControl">
        <button class="layerBtn" data-idx="1">Layer2</button>
        <input class="layerOpacity" data-idx="1" type="range" min="0" max="100" value="100">
      </div>
      <div class="layerControl">
        <button class="layerBtn" data-idx="0">Layer1</button>
        <input class="layerOpacity" data-idx="0" type="range" min="0" max="100" value="100">
      </div>
    </div>
    <button id="undoBtn" disabled>Undo</button>
    <button id="clearBtn">Clear</button>
    <button id="saveBtn">Save PNG</button>
  </div>
  <canvas id="viewCanvas"></canvas>
  <script>
    // ツールバードラッグ
    const toolbar = document.getElementById('toolbar');
    let dragging = false, dx = 0, dy = 0;
    toolbar.addEventListener('pointerdown', e => {
      if (e.target === toolbar) { dragging = true; dx = e.clientX - toolbar.offsetLeft; dy = e.clientY - toolbar.offsetTop; }
    });
    document.addEventListener('pointermove', e => {
      if (dragging) { toolbar.style.left = `${e.clientX - dx}px`; toolbar.style.top = `${e.clientY - dy}px`; toolbar.style.right = 'auto'; }
    });
    document.addEventListener('pointerup', () => { dragging = false; });

    // 描画設定
    let mode = 'draw', FULL = 3000, LAYERS = 3;
    const view = document.getElementById('viewCanvas'), ctx = view.getContext('2d');
    const layers = [], lctx = [], alpha = [];
    for (let i = 0; i < LAYERS; i++) { const c = document.createElement('canvas'); c.width = c.height = FULL; layers.push(c); lctx.push(c.getContext('2d')); alpha.push(1); }
    const baseCanvas = document.createElement('canvas'); baseCanvas.width = baseCanvas.height = FULL;
    const baseCtx = baseCanvas.getContext('2d'); baseCtx.fillStyle = '#ffffff'; baseCtx.fillRect(0, 0, FULL, FULL);
    let active = 2, history = [];
    let penW = 5, ersW = 20, penCol = 'rgb(0,0,0)', memCol = 'rgb(255,255,255)';
    let scale = 0.3, ox = 0, oy = 0;

    function resize() { view.width = innerWidth; view.height = innerHeight; render(); }
    window.addEventListener('resize', resize); resize();

    function render() { ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,view.width,view.height); ctx.setTransform(scale,0,0,scale,ox,oy); ctx.globalAlpha = 1; ctx.drawImage(baseCanvas,0,0); layers.forEach((ly,i) => { ctx.globalAlpha = alpha[i]; ctx.drawImage(ly,0,0); }); }
    function toFull(x,y) { return [(x-ox)/scale,(y-oy)/scale]; }

    // ツール切替
    const penBtn = document.getElementById('penBtn'), eraserBtn = document.getElementById('eraserBtn');
    penBtn.onclick = () => { mode = 'draw'; penBtn.classList.add('active'); eraserBtn.classList.remove('active'); };
    eraserBtn.onclick = () => { mode = 'erase'; eraserBtn.classList.add('active'); penBtn.classList.remove('active'); };

    // コントロール
    document.getElementById('penSize').oninput = function() { penW = this.value; document.getElementById('penSizeLabel').textContent = this.value; };
    document.getElementById('eraserSize').oninput = function() { ersW = this.value; document.getElementById('eraserSizeLabel').textContent = this.value; };

    // レイヤー選択
    document.querySelectorAll('.layerBtn').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.layerBtn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        active = +btn.dataset.idx;
      };
    });
    document.querySelectorAll('.layerOpacity').forEach(sl => {
      sl.oninput = function() { alpha[this.dataset.idx] = this.value/100; render(); };
    });

    // Undo/Clear/Save
    const undoBtn = document.getElementById('undoBtn');
    function recordSnapshot() { const snap = layers.map((c,i) => lctx[i].getImageData(0,0,FULL,FULL)); history.push(snap); if(history.length>10) history.shift(); undoBtn.disabled = false; }
    undoBtn.onclick = () => { if(history.length) { const snap = history.pop(); snap.forEach((img,i) => lctx[i].putImageData(img,0,0)); render(); undoBtn.disabled = history.length===0; } };
    document.getElementById('clearBtn').onclick = () => { recordSnapshot(); layers.forEach(c => c.getContext('2d').clearRect(0,0,FULL,FULL)); render(); };
    document.getElementById('saveBtn').onclick = () => { const tmp = document.createElement('canvas'); tmp.width = tmp.height = FULL; const tctx = tmp.getContext('2d'); tctx.drawImage(baseCanvas,0,0); layers.forEach((ly,i) => { tctx.globalAlpha = alpha[i]; tctx.drawImage(ly,0,0); }); const a = document.createElement('a'); a.download = 'drawing.png'; a.href = tmp.toDataURL(); a.click(); };

    // 描画/パン
    let drawing = false, panning = false, psx = 0, psy = 0;
    view.style.touchAction = 'none';
    view.addEventListener('pointerdown', e => {
      e.preventDefault();
      if(e.button===1) { panning = true; psx = e.clientX; psy = e.clientY; return; }
      recordSnapshot(); drawing = true;
      const oc = lctx[active];
      oc.globalCompositeOperation = mode==='erase' ? 'destination-out':'source-over';
      oc.lineCap = oc.lineJoin = 'round';
      oc.lineWidth = (mode==='draw' ? penW : ersW)/scale;
      oc.strokeStyle = penCol; oc.globalAlpha = 1;
      const [fx,fy] = toFull(e.clientX,e.clientY); oc.beginPath(); oc.moveTo(fx,fy);
    });
    view.addEventListener('pointermove', e => {
      e.preventDefault(); const oc = lctx[active];
      if(drawing) { const [fx,fy] = toFull(e.clientX,e.clientY); oc.lineTo(fx,fy); oc.stroke(); render(); }
      else if(panning) { ox += e.clientX-psx; oy += e.clientY-psy; psx = e.clientX; psy = e.clientY; render(); }
    });
    ['pointerup','pointercancel'].forEach(evt => document.addEventListener(evt, () => { drawing = panning = false; }));
    view.addEventListener('wheel', e => { e.preventDefault(); const f=e.deltaY<0?1.1:0.9; const mx=e.clientX,my=e.clientY; const lx=(mx-ox)/scale, ly=(my-oy)/scale; scale=Math.min(10,Math.max(.2,scale*f)); ox=mx-lx*scale; oy=my-ly*scale; render(); },{passive:false});
    view.addEventListener('contextmenu', e => e.preventDefault());

    // 色選択
    const hueCv=document.getElementById('hueRing'), svCv=document.getElementById('svBox');
    const hctx=hueCv.getContext('2d'), svctx=svCv.getContext('2d');
    const cur=document.getElementById('currentColor'), mem=document.getElementById('memoryColor'), rgbDisp=document.getElementById('rgbValue');
    const OR=100, RW=24, SZ=100; let hue=0, hPick=false, svPick=false;
    function drawHue(){ hctx.clearRect(0,0,200,200); for(let a=0;a<360;a++){ const s=(a-1)*Math.PI/180,e=a*Math.PI/180; hctx.beginPath(); hctx.lineWidth=RW; hctx.arc(OR,OR,OR-RW/2,s,e); hctx.strokeStyle=`hsl(${(a+180)%360},100%,50%)`; hctx.stroke(); }}
    function drawSV(){ svctx.clearRect(0,0,SZ,SZ); const gs=svctx.createLinearGradient(0,0,SZ,0); gs.addColorStop(0,'#fff'); gs.addColorStop(1,`hsl(${hue},100%,50%)`); svctx.fillStyle=gs; svctx.fillRect(0,0,SZ,SZ); const gv=svctx.createLinearGradient(0,0,0,SZ); gv.addColorStop(0,'rgba(0,0,0,0)'); gv.addColorStop(1,'rgba(0,0,0,1)'); svctx.fillStyle=gv; svctx.fillRect(0,0,SZ,SZ); }
    function updateDisplays(){ cur.style.background=penCol; rgbDisp.textContent=penCol; }
    drawHue(); drawSV(); updateDisplays();
    function pickHue(x,y){ const r=hueCv.getBoundingClientRect(), dx=x-(r.left+OR), dy=y-(r.top+OR), d=Math.sqrt(dx*dx+dy*dy); if(d<OR-RW||d>OR) return; hue=(Math.atan2(dy,dx)*180/Math.PI+360+180)%360; drawSV(); }
    function pickSV(x,y){ const r=svCv.getBoundingClientRect(), px=Math.min(Math.max(x-r.left,0),SZ-1), py=Math.min(Math.max(y-r.top,0),SZ-1), dat=svctx.getImageData(px,py,1,1).data; penCol=`rgb(${dat[0]},${dat[1]},${dat[2]})`; updateDisplays(); }
    hueCv.addEventListener('pointerdown',e=>{ hPick=true; pickHue(e.clientX,e.clientY); }); svCv.addEventListener('pointerdown',e=>{ svPick=true; pickSV(e.clientX,e.clientY); });
    document.addEventListener('pointermove',e=>{ if(hPick) pickHue(e.clientX,e.clientY); if(svPick) pickSV(e.clientX,e.clientY); });
    document.addEventListener('pointerup',()=>{ hPick=svPick=false; });
    mem.addEventListener('click',()=>{ [penCol,memCol]=[memCol,penCol]; updateDisplays(); mem.style.background=memCol; });
    mem.addEventListener('contextmenu',e=>{ e.preventDefault(); memCol=penCol; mem.style.background=memCol; });
  </script>
</body>
</html>
